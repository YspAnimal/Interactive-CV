library(data.table)
library(dplyr)
library(tidyr)
library(ggplot2)
library(GGally)
library(lmtest)
library(sandwich)
library(factoextra) #Advance distance and clustering methods


Dataset <- fread("Proby.csv", colClasses=c("factor","numeric","numeric",
                                                  "numeric","numeric","numeric",
                                                  "numeric"), na.strings="")
glimpse(Dataset)

convertToNumeric <- function(x) {as.numeric(sub(",", ".", x, fixed = TRUE))}

Dataset %<>% group_by(Point) %>% mutate_all(convertToNumeric) %>% ungroup()

ggpairs(log(Dataset[, -1]))

NArows <- Dataset %>% filter_all(any_vars(is.na(.)))
Validrows <- Dataset[complete.cases(Dataset), ]
cor(Validrows[, -1])

model <- lm(BIOup ~ FOSup, Validrows[, -1]) ## Predictors are found from correlation matrix

NArows$BIOup <- predict(model, NArows[,-1])
summary(model)
plot(model)
coeftest(model, vcov. = vcovHAC(model))
ggplot(Validrows, aes(x = BIOup, y = FOSup)) + geom_line()



ValidDataset <- Validrows

rownames(ValidDataset) <- ValidDataset$Point
ValidDataset <- ValidDataset %>% select(-Point) %>% as.matrix()


pr.comp <- prcomp(ValidDataset, scale = TRUE)
summary(pr.comp)
plot(pr.comp$x[,1:2], pch =19,
     xlab ="Z1",ylab="Z2")

biplot(pr.comp,choices = c(1,2), pch =19,
     xlab ="Z2",ylab="Z3")

fviz_pca_var(pr.comp)



ValidDataset <- Validrows
rownames(ValidDataset) <- ValidDataset$Point
WithoutBIO <- ValidDataset %>%select(-c(1,4,5))%>% as.matrix()
pr.comp <- prcomp(WithoutBIO, scale = TRUE)
summary(pr.comp)
plot(pr.comp$x[,1:2], pch =19,
     xlab ="Z1",ylab="Z2")

biplot(pr.comp,choices = c(1,2), pch =19,
       xlab ="Z2",ylab="Z3")

fviz_pca_var(pr.comp)



########### Clustering HC

scaleValidDataset <- scale(ValidDataset[, -1])
rownames(scaleValidDataset) <- ValidDataset$Point

distManh <- dist(scaleValidDataset, method = 'manhattan')
corr.dist <- get_dist(scaleValidDataset, method = 'pearson')

HCmodel <- hclust(distManh, method ="ward.D2")
HCmodelCorr <- hclust(corr.dist, method ="ward.D2") # Produce very good result for south points!!!!

plot(HCmodel)
plot(HCmodelCorr)



library(cluster)  
library(factoextra)

fviz_nbclust(ValidDataset[, -1], pam, method = 'silhouette') + theme_classic() #2,3,5 clusters on monetary and 4,5,6 on behavior
PAMclusters <- pam(ValidDataset[, -1], 3)
plot(PAMclusters)

ValidDataset$Cluster <- PAMclusters$clustering


####### Correlation based clustering
dist.corr <- get_dist(scaleValidDataset, method = 'pearson')
fviz_dist(dist.corr)
heatmap(scaleValidDataset, scale = 'none')

pr.comp <- prcomp(scaleValidDataset)
summary(pr.comp)
plot(pr.comp$x [,1:3], pch =19,
     xlab ="Z1",ylab="Z2")


####### try to use only UP or DOWN points for clusters

ValidDataset <- Validrows

ValidDataset <- ValidDataset %>% select(-Point, -c(3,5,7)) %>% as.matrix()
rownames(ValidDataset) <- Validrows$Point
str(ValidDataset)

pr.comp <- prcomp(ValidDataset, scale = TRUE)
summary(pr.comp)
plot(pr.comp$x[,1:2], pch =19,
     xlab ="Z1",ylab="Z2")

biplot(pr.comp,choices = c(2,3), pch =19,
       xlab ="Z2",ylab="Z3")

fviz_pca_var(pr.comp)








